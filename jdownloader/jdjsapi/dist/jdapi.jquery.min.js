/*
 
 ##JDownloader API Bindings for jQuery
 - - -
 namespace** jQuery.jd<br/>
 @version 07/2011
 @author mhils

 The JDownloader API provides both a polling and an event streaming interface. 
 This wrapper is the client side reference implementation containing all features of the API.


*/
(function(a){a.jd={setOptions:function(b){b&&a.extend(a.jd._settings,b);a.jd._settings.apiServer.match(/\/$/)||(a.jd._settings.apiServer+="/");return this},getOptions:function(){return a.extend(!0,{},a.jd._settings)},startSession:function(b,c,d){if(a.jd._ajax.sessionStatus!==a.jd.e.sessionStatus.NO_SESSION){if(a.jd._ajax.sessionStatus===a.jd.e.sessionStatus.REGISTERED)return d({status:a.jd._ajax.sessionStatus,data:"already logged in"}),this;a.jd.stopSession(function(){a.jd.startSession(b,c,d)});return this}a.isFunction(b)&&
(d=b,b=c=void 0);a.jd._settings.user=b?b:a.jd._settings.user;a.jd._settings.pass=c?c:a.jd._settings.pass;var e=a.isFunction(d);a.jd.send("session/handshake",a.jd._settings.user?[a.jd._settings.user,a.jd._settings.pass]:["",""],function(f){a.jd._ajax.debug("Handshake response:",f);if(f&&typeof f==="string"&&f!==""&&f!==a.jd.e.sessionStatus.ERROR){var g=a.jd._settings.user?a.jd.e.sessionStatus.REGISTERED:a.jd.e.sessionStatus.ANONYMOUS;a.jd._ajax.token=f;a.jd._settings.user=b;a.jd._settings.pass=c;a.jd._ajax.sessionStatus=
g;e&&d({status:a.jd._ajax.sessionStatus,data:f})}else e&&d({status:a.jd.e.sessionStatus.ERROR,data:f})},function(b){e&&d({status:a.jd.e.sessionStatus.ERROR,data:b})});return this},stopSession:function(b){if(a.jd._ajax.sessionStatus===a.jd.e.sessionStatus.NO_SESSION)return b(),this;a.jd.stopPolling();a.jd._ajax.token=void 0;a.jd._ajax.subscriptions={};a.jd._ajax.sessionStatus=a.jd.e.sessionStatus.NO_SESSION;a.jd.send("session/disconnect",b,b);return this},getSessionStatus:function(){return a.jd._ajax.sessionStatus},
startPolling:function(){if(a.jd.isPollingContinuously())return this;a.jd._ajax.active=!0;a.jd._ajax.lastEventId=void 0;a.jd.pollOnce();return this},subscribe:function(b,c,d){b=a.jd._ajax.cleanNamespace(b);if(b in a.jd._ajax.subscriptions){if(!a.isFunction(c))return this;for(var e=a.jd._ajax.subscriptions[b],f=0;f<e.length;f++)if(e[f]===c)return a.isFunction(d)&&d({status:"already subscribed with that callback"}),this;a.jd._ajax.subscriptions[b].push(c);a.isFunction(d)&&d({status:"callback added"})}else{a.isFunction(c)&&
(a.jd._ajax.subscriptions[b]=[c]);if(b==="*"&&a.isFunction(c))a.jd._settings.onmessage=c;a.jd.send(b+"/subscribe",d,d)}return this},unsubscribe:function(b,c){var b=a.jd._ajax.cleanNamespace(b),d={};if(b==="*")d=a.jd._ajax.subscriptions;else if(b in a.jd._ajax.subscriptions)d[b]=a.jd._ajax.subscriptions[b];else return a.isFunction(c)&&c({status:"already unsubscribed"}),this;a.each(d,function(b){a.jd.send(b+"/unsubscribe");delete a.jd._ajax.subscriptions[b]});return this},stopPolling:function(){a.jd._ajax.active=
!1;a.jd._ajax.jqXHR&&a.jd._ajax.jqXHR.abort&&a.jd._ajax.jqXHR.abort();a.jd._ajax.lastEventId=void 0;return this},isPollingContinuously:function(){return a.jd._ajax.active},pollOnce:function(){a.jd._ajax.sessionStatus===a.jd.e.sessionStatus.NO_SESSION?(a.jd.stopPolling(),a.jd._ajax.handlePoll({type:a.jd.e.messageType.SYSTEM,message:a.jd.e.sysMessage.ERROR,data:{status:"No active session. Did you call startSession()?"}})):(a.jd._ajax.jqXHR!==null&&a.jd._ajax.jqXHR.abort(),a.jd._ajax.jqXHR=a.ajax({dataType:a.jd._settings.forceJSONP||
!a.support.cors?"jsonp":"json",type:"GET",url:a.jd.getURL("events/listen"),data:{token:a.jd._ajax.token,lastEventId:a.jd._ajax.lastEventId},async:!0,cache:!1,timeout:a.jd._settings.apiTimeout,success:a.jd._ajax.handlePoll,complete:a.jd._ajax.pollComplete,error:a.jd._ajax.pollError}),a.jd._ajax.debug("pollOnce",a.jd._ajax.lastEventId,a.jd._ajax.jqXHR));return this},getURL:function(b,c){var b=a.jd._ajax.cleanNamespace(b),d="";c&&(d="?"+a.param({token:a.jd._ajax.token,p:c}));return a.jd._settings.apiServer+
b+d},send:function(b,c,d,e,f){a.isFunction(c)&&(f=e,e=d,d=c,c=void 0);a.isFunction(d)||(d=void 0);a.isFunction(f)||(f=void 0);a.isFunction(e)||(e=void 0);if(!a.isArray(c)&&c!==void 0)if(a.isPlainObject(c)){var g=[];a.each(c,function(a,b){g.push(b)});c=g}else c=a.makeArray(c);a.jd._ajax.debug(a.jd.getURL(b),c,d,e,f);a.ajax({dataType:a.jd._settings.forceJSONP||!a.support.cors?"jsonp":"json",type:"GET",url:a.jd.getURL(b),data:{token:a.jd._ajax.token,p:c},async:!0,cache:!1,timeout:a.jd._settings.apiTimeout,
success:function(b){a.jd._ajax.sendSuccess(b,d,e,f)},error:function(b,c,d){a.jd._ajax.sendError(b,c,d,e)}});return this},_settings:{user:void 0,pass:void 0,apiServer:"http://127.0.0.1:3128/",onmessage:void 0,onerror:void 0,debug:!1,apiTimeout:31E3,forceJSONP:!1},e:{sessionStatus:{NO_SESSION:void 0,ERROR:"error",ANONYMOUS:"anonymous",REGISTERED:"registered"},messageType:{SYSTEM:"system"},sysMessage:{ERROR:"error",DISCONNECT:"disconnect",HEARTBEAT:"heartbeat",OUT_OF_SYNC:"outofsync"}},_ajax:{lastEventId:void 0,
active:!1,jqXHR:null,pidCallbacks:{},subscriptions:{},token:void 0,sessionStatus:void 0,sendSuccess:function(b,c,d,e){a.jd._ajax.debug("sendSuccess:",b);b.type&&b.type===a.jd.e.messageType.SYSTEM&&b.message&&b.message===a.jd.e.sysMessage.ERROR?a.isFunction(d)&&d(b.data):(b.pid&&a.isFunction(e)&&(a.jd._ajax.pidCallbacks[b.pid]=e,a.jd._ajax.debug("Register PID...",b)),jQuery.isFunction(c)&&c(b.data,b.pid))},handlePoll:function(b){a.jd._ajax.debug("handlePoll: ",b,b.id,a.jd._ajax.lastEventId);if(a.jd._ajax.lastEventId===
void 0||b.data&&a.jd._ajax.lastEventId===b.id-b.data.length||b.type&&b.type===a.jd.e.messageType.SYSTEM){if(b.data&&!(b.type&&b.type==a.jd.e.messageType.SYSTEM))a.jd._ajax.lastEventId=b.id;if(b.type&&b.type===a.jd.e.messageType.SYSTEM)switch(b.message){case a.jd.e.sysMessage.DISCONNECT:a.jd.stopPolling();if(a.isFunction(a.jd._settings.onerror))a.jd._settings.onerror({status:a.jd.e.sysMessage.DISCONNECT});break;case a.jd.e.sysMessage.HEARTBEAT:break;case a.jd.e.sysMessage.OUT_OF_SYNC:a.jd.stopPolling();
if(a.isFunction(a.jd._settings.onerror))a.jd._settings.onerror({status:a.jd.e.sysMessage.OUT_OF_SYNC});break;default:if(a.isFunction(a.jd._settings.onerror))a.jd._settings.onerror(b.data)}else a.jd._ajax.debug(b.data.length+" events in this message."),a.each(b.data,function(b,d){a.jd._ajax.handleEvent(d)})}else a.jd._ajax.debug("Invalid Message id")},handleEvent:function(b){if(!(b.pid&&b.pid in a.jd._ajax.pidCallbacks&&a.jd._ajax.pidCallbacks[b.pid](b.data,b.namespace,b.pid)===!1)&&(b.namespace&&
b.namespace in a.jd._ajax.subscriptions&&a.each(a.jd._ajax.subscriptions[b.namespace],function(a,d){d(b.data,b.namespace,b.pid)}),a.isFunction(a.jd._settings.onmessage)))a.jd._settings.onmessage(b.data,b.namespace,b.pid)},pollComplete:function(){a.jd._ajax.debug("pollComplete",a.jd._ajax.lastEventId);a.jd._ajax.jqXHR=null;a.jd._ajax.active&&a.jd._ajax.active===!0&&(a.jd._settings.debug===!0?setTimeout(a.jd.pollOnce,2E3):a.jd.pollOnce())},pollError:function(b,c,d){a.jd._ajax.handlePoll({type:a.jd.e.messageType.SYSTEM,
message:a.jd.e.sysMessage.ERROR,data:{jqXHR:b,status:c,errorThrown:d}})},sendError:function(b,c,d,e){a.isFunction(e)&&e({jqXHR:b,status:c,errorThrown:d})},debug:function(b){a.jd._settings.debug===!0&&window.console&&console.log(Array.prototype.slice.call(arguments))},cleanNamespace:function(a){a[a.length-1]==="/"&&(a=a.slice(0,-1));a[0]==="/"&&(a=a.substr(1));return a}}}})(jQuery);